/*
Fecha: 2015-10-20

- Se resume la infromacion por pozo
- SÃ³lo se agregan piezometros con al menos un dato de groundwaterelevation (gwe) distinto de NULL y con coordenadas locales (si no no se pueden agrupar por pozo)
- Se agrega la info relevante de cada piezometro dentro del pozo como una lista ordenada
*/
-- Eliminar vista si existe
DROP VIEW
IF EXISTS piezometria.v_piezometro_consolidado;

-- Crear vista
CREATE
OR REPLACE VIEW piezometria.v_piezometro_consolidado AS (
 SELECT t1.id_piezometro,
    t2.id_piezometro_pozo,
    t1.fecha,
-- Se reemplazan los nulos por el valor "-9999"
    GREATEST(t1.groundwaterelevation, ((-9999))::double precision) AS groundwaterelevation,
    GREATEST(t1.cota_superficie, ((-9999))::double precision) AS cota_superficie,
    GREATEST(t1.cota_sensor, ((-9999))::double precision) AS cota_sensor,
    GREATEST((t1.cota_superficie - t1.cota_sensor), ((-9999))::double precision) AS profundidad,
    t1.geom,
    t1.x_local,
    t1.y_local
  FROM 
		piezometria.v_piezometro_consolidado_v0 t1
  JOIN (
		SELECT 
			v_piezometro_consolidado_v0.x_local,
      v_piezometro_consolidado_v0.y_local,
      min((v_piezometro_consolidado_v0.id_piezometro)::text) AS id_piezometro_pozo
    FROM 
			piezometria.v_piezometro_consolidado_v0
    GROUP BY 
			v_piezometro_consolidado_v0.x_local,
			v_piezometro_consolidado_v0.y_local
    ORDER BY 
			min((v_piezometro_consolidado_v0.id_piezometro)::text)
	) t2 
	ON (
		(t1.x_local = t2.x_local) 
		AND (t1.y_local = t2.y_local)
	)
  ORDER BY 
		t1.id_piezometro,
		t1.fecha
);